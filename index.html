<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MY.TBSERVER IPTV</title>
  <style>
    :root{ --bg:#07090d; --panel:#101218; --stroke:rgba(255,255,255,.12); --text:#fff; --muted:rgba(255,255,255,.7); --accent:#6ea8ff; }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    .wrap{display:grid; grid-template-columns: 420px 1fr; gap:12px; height:100%; padding:12px; box-sizing:border-box;}
    .panel{background:rgba(16,18,24,.86); border:1px solid var(--stroke); border-radius:16px; overflow:hidden;}
    header{padding:12px 14px; border-bottom:1px solid var(--stroke); display:flex; align-items:center; justify-content:space-between;}
    header b{font-size:14px; letter-spacing:.4px;}
    header .hint{font-size:12px; color:var(--muted)}
    #list{height:calc(100% - 54px); overflow:auto;}
    .item{padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer; display:flex; gap:10px; align-items:center;}
    .item:hover{background:rgba(255,255,255,.04);}
    .item.active{background:rgba(110,168,255,.16);}
    .logo{width:40px;height:24px;object-fit:contain; background:rgba(255,255,255,.06); border-radius:6px; flex:0 0 auto;}
    .meta{min-width:0;}
    .name{font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .group{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .player{position:relative;}
    video{width:100%; height:100%; background:#000; border-radius:16px; border:1px solid var(--stroke);}
    .osd{
      position:absolute; left:16px; right:16px; bottom:16px;
      background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12);
      border-radius:14px; padding:10px 12px; display:flex; gap:10px; align-items:center;
      opacity:0; transform:translateY(8px); transition:.18s ease;
    }
    .osd.show{opacity:1; transform:translateY(0);}
    .badge{background:rgba(110,168,255,.22); border:1px solid rgba(110,168,255,.35); padding:3px 8px; border-radius:999px; font-size:12px;}
    .osd .title{font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .osd .sub{font-size:12px; color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <header>
        <b>MY.TBSERVER • Canale</b>
        <div class="hint">▲▼ OK • GREEN Refresh • 0-9 Jump</div>
      </header>
      <div id="list"></div>
    </div>

    <div class="player">
      <video id="video" autoplay muted playsinline></video>
      <div id="osd" class="osd">
        <span class="badge">LIVE</span>
        <div style="min-width:0">
          <div id="osdTitle" class="title">—</div>
          <div id="osdSub" class="sub">—</div>
        </div>
      </div>
    </div>
  </div>

<script>
/** === SETEAZĂ AICI M3U URL-ul tău === */
const M3U_URL = "https://owncloud.tbserver.online/index.php/s/bB3v3IuXhhcfeOa/download"; // <- pune URL-ul tău aici

const listEl = document.getElementById("list");
const video = document.getElementById("video");
const osd = document.getElementById("osd");
const osdTitle = document.getElementById("osdTitle");
const osdSub = document.getElementById("osdSub");

let channels = [];
let focusIndex = 0;
let osdTimer = null;

function showOSD(title, sub=""){
  osdTitle.textContent = title || "—";
  osdSub.textContent = sub || "";
  osd.classList.add("show");
  clearTimeout(osdTimer);
  osdTimer = setTimeout(()=>osd.classList.remove("show"), 2500);
}

function safeRegisterKeys(){
  try{
    if (window.tizen && tizen.tvinputdevice){
      const keys = [
        "ColorF1Green","ColorF0Red","ColorF2Yellow","ColorF3Blue",
        "MediaPlayPause","MediaStop","Return","Exit",
        "Up","Down","Left","Right","Enter",
        "ChannelUp","ChannelDown","VolumeUp","VolumeDown","VolumeMute"
      ];
      keys.forEach(k => { try{ tizen.tvinputdevice.registerKey(k); }catch(e){} });
    }
  }catch(e){}
}

function parseM3U(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  let cur = null;

  for (const line of lines){
    if (line.startsWith("#EXTINF")){
      cur = { name:"(fără nume)", url:"", logo:"", group:"", raw: line };
      // name
      const comma = line.indexOf(",");
      if (comma !== -1) cur.name = line.slice(comma+1).trim() || cur.name;

      // attrs
      const attrs = {};
      const re = /([\w-]+)="([^"]*)"/g;
      let m;
      while ((m = re.exec(line)) !== null){
        attrs[m[1]] = m[2];
      }
      cur.logo = attrs["tvg-logo"] || "";
      cur.group = attrs["group-title"] || "";
    } else if (!line.startsWith("#")){
      if (cur){
        cur.url = line;
        out.push(cur);
        cur = null;
      }
    }
  }
  return out;
}

function render(){
  listEl.innerHTML = "";
  channels.forEach((ch, idx) => {
    const row = document.createElement("div");
    row.className = "item" + (idx===focusIndex ? " active":"");
    row.dataset.idx = idx;

    const img = document.createElement("img");
    img.className = "logo";
    img.alt = "";
    img.src = ch.logo || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='72'%3E%3Crect width='120' height='72' fill='%23101318'/%3E%3Ctext x='60' y='42' font-size='16' text-anchor='middle' fill='rgba(255,255,255,.5)'%3ETwitter%3C/text%3E%3C/svg%3E";

    const meta = document.createElement("div");
    meta.className = "meta";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = `${String(idx+1).padStart(2,"0")} • ${ch.name}`;

    const group = document.createElement("div");
    group.className = "group";
    group.textContent = ch.group || "";

    meta.appendChild(name);
    meta.appendChild(group);

    row.appendChild(img);
    row.appendChild(meta);

    row.onclick = () => { focusIndex = idx; playFocused(true); };
    listEl.appendChild(row);
  });

  // scroll into view
  const active = listEl.querySelector(".item.active");
  if (active) active.scrollIntoView({ block:"center" });
}

async function loadM3U(){
  showOSD("Încarc playlist…", M3U_URL);
  const res = await fetch(M3U_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("Fetch failed: " + res.status);
  const text = await res.text();
  channels = parseM3U(text);
  if (!channels.length) throw new Error("Playlist gol / nevalid.");
  focusIndex = 0;
  render();
  playFocused(true);
}

function setActiveUI(){
  [...listEl.querySelectorAll(".item")].forEach(el => el.classList.remove("active"));
  const el = listEl.querySelector(`.item[data-idx="${focusIndex}"]`);
  if (el){ el.classList.add("active"); el.scrollIntoView({ block:"center" }); }
}

function playFocused(autoplay){
  const ch = channels[focusIndex];
  if (!ch) return;

  setActiveUI();
  showOSD(ch.name, ch.group || "LIVE");

  // simple: video src = m3u8 / stream url
  video.pause();
  video.removeAttribute("src");
  video.load();

  video.src = ch.url;
  if (autoplay){
    video.play().catch(()=>{ /* pe TV uneori cere user gesture; OK rezolvă */ });
  }
}

function onKey(e){
  const key = e.key;

  // Tizen: e.key poate fi "Enter", "ArrowUp" etc.
  if (key === "ArrowUp"){ focusIndex = Math.max(0, focusIndex-1); setActiveUI(); showOSD(channels[focusIndex]?.name, ""); e.preventDefault(); }
  else if (key === "ArrowDown"){ focusIndex = Math.min(channels.length-1, focusIndex+1); setActiveUI(); showOSD(channels[focusIndex]?.name, ""); e.preventDefault(); }
  else if (key === "Enter"){ playFocused(true); e.preventDefault(); }
  else if (key === "MediaPlayPause"){ if (video.paused) video.play(); else video.pause(); e.preventDefault(); }
  else if (key === "MediaStop"){ video.pause(); e.preventDefault(); }
  else if (key === "ColorF1Green"){ loadM3U().catch(err=>showOSD("Eroare M3U", err.message)); e.preventDefault(); }
  else if (/^[0-9]$/.test(key)){
    // jump: tastezi 1..9 => sare în listă
    const n = parseInt(key,10);
    const idx = Math.min(channels.length-1, Math.max(0, n-1));
    focusIndex = idx;
    playFocused(true);
    e.preventDefault();
  } else if (key === "Return" || key === "Escape"){
    // opțional: închide OSD
    osd.classList.remove("show");
    e.preventDefault();
  }
}

safeRegisterKeys();
document.addEventListener("keydown", onKey, { passive:false });

loadM3U().catch(err => showOSD("Eroare M3U", err.message));
</script>
</body>
</html>{
  "name": "mytbserver-iptv",
  "version": "1.0.0",
  "description": "MY.TBSERVER IPTV (TizenBrew app module)",
  "packageType": "app",
  "appName": "MY.TBSERVER IPTV",
  "appPath": "app/index.html",
  "keys": [
    "ColorF0Red",
    "ColorF1Green",
    "ColorF2Yellow",
    "ColorF3Blue",
    "MediaPlayPause",
    "MediaStop",
    "MediaRewind",
    "MediaFastForward",
    "MediaTrackPrevious",
    "MediaTrackNext",
    "ChannelUp",
    "ChannelDown",
    "VolumeUp",
    "VolumeDown",
    "VolumeMute",
    "Exit",
    "Return",
    "Enter",
    "Up",
    "Down",
    "Left",
    "Right"
  ]
}
